---
- name: Install MySQL Server
  become_user: root
  become: true
  apt: pkg={{ item }} state=latest
  with_items:
    - mysql-server-5.6
    - python-mysqldb

- name: Check to see if MySQL password already reset
  stat: path=~/.my.cnf
  register: mysql_myconf_file

- name: Update MySQL root password
  include_tasks: root_passwd.yml
  when: mysql_myconf_file.stat.exists is defined and mysql_myconf_file.stat.exists == false

- name: Configure default encoding and collation for MySQL
  become_user: root
  become: true
  ini_file: dest=/etc/mysql/my.cnf section={{ item.section }} option={{ item.option }} value={{ item.value }}
  with_items:
    - { section: 'mysqld', option: 'collation-server', value: 'utf8mb4_unicode_ci' }
    - { section: 'mysqld', option: 'character-set-server', value: 'utf8mb4' }

- name: Create MySQL database for WordPress
  mysql_db: name={{ wp.db.name }} state=present collation=utf8_general_ci encoding=utf8
  register: wp_db_created

- name: Create MySQL user for WordPress
  mysql_user: name={{ wp.db.user }} password={{ wp.db.pass }} host="%" priv=*.*:ALL,GRANT state=present

- name: Restart MySQL server
  become_user: root
  become: true
  service: name=mysql state=restarted
